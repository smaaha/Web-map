<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        </style>
        <title>Turku tramline impact¬†on service accessibility </title>
    </head>
    <body>
        <div id="map">
        </div>
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="data/Postalcodeareas_1.js"></script>
        <script src="data/Buffers_2.js"></script>
        <script src="data/Tramline_3.js"></script>
        <script src="data/Tramstops_4.js"></script>
        <script src="data/Wellbeingservicesmerged_5.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
        <script>
          var highlightLayer;
        function highlightFeature(e) {
            highlightLayer = e.target;

              highlightLayer.setStyle({
                color: '#ffff00',
				  weight:4,
				  opacity: 0.5
              });           
        }
        var map = L.map('map', {
            zoomControl:false, maxZoom:28, minZoom:5
        })
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        // remove popup's row if "visible-with-data"
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        // add class to format popup if it contains media
		function addClassToPopupIfMedia(content, popup) {
			var tempDiv = document.createElement('div');
			tempDiv.innerHTML = content;
			if (tempDiv.querySelector('td img')) {
				popup._contentNode.classList.add('media');
					// Delay to force the redraw
					setTimeout(function() {
						popup.update();
					}, 10);
			} else {
				popup._contentNode.classList.remove('media');
			}
		}
        var title = new L.Control({'position':'topleft'});
        title.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info');
            this.update();
            return this._div;
        };
        title.update = function () {
           // Add a white box with text after the heading
            this._div.innerHTML = `
				<div style="
					background-color: rgba(255,255,255,0.9);
					padding: 6px 10px;
					border-radius: 6px;
					max-width: 400px;
					line-height: 1.3;
					font-size: 13px;
					box-shadow: 0 1px 4px rgba(0,0,0,0.2);
					        ">
					            <h3 style="margin: 0 0 4px 0; font-size: 18px;">Turku tramline impact on service accessibility</h3>
					            <p style="margin: 0;">Helping Turku city decision-makers explore whether the tramline improves access to wellbeing services in socio-economically diverse areas</p>
					        </div>
					    `;
					};
				
        title.addTo(map);
        var abstract = new L.Control({ position: 'bottomleft' });

var abstract = new L.Control({ position: 'bottomleft' });

abstract.onAdd = function (map) {
    // Creating Instruction box that is a pop-up
    this._div = L.DomUtil.create('div', 'leaflet-control leaflet-bar');
    this._div.style.background = "rgba(255,255,255,0.95)";
    this._div.style.padding = "6px";
    this._div.style.borderRadius = "6px";
    this._div.style.boxShadow = "0 1px 4px rgba(0,0,0,0.3)";
    this._div.style.fontSize = "13px";
    this._div.style.lineHeight = "1.4";
    this._div.style.maxWidth = "280px";

    // Adding the text
    this._div.innerHTML = `
        <button id="instructionsToggle" style="
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
        ">Instructions ‚ñº</button>
        <div id="instructionsContent" style="display:none; margin-top:6px;">
            <p>
                ‚Ä¢ The map provides an overview of the socio-economic status of different districts in Turku, alongside the planned tramline and its stops.<br><br>
                ‚Ä¢ By observing the heatmaps, you can see how municipal wellbeing-related services ‚Äî schools, sports & wellbeing, and culture ‚Äî are distributed across the city in relation to socio-economic areas and the tram route.<br><br>
                ‚Ä¢ You can toggle map layers on and off using the panel in the top-right corner.<br><br>
				‚Ä¢ For more detailed information, click on a tram stop to view which and how many services are within a 400 m walking distance.<br><br>
                ‚Ä¢ Click on postal code areas to view socio-economic details: share of people with basic education only, median income, and unemployment rate (%).
            </p>
        </div>
    `;

    const toggle = this._div.querySelector('#instructionsToggle');
    const content = this._div.querySelector('#instructionsContent');

    toggle.onclick = function (e) {
        e.stopPropagation(); 
        if (content.style.display === "none") {
            content.style.display = "block";
            toggle.innerHTML = "Instructions ‚ñ≤";
        } else {
            content.style.display = "none";
            toggle.innerHTML = "Instructions ‚ñº";
        }
    };

    L.DomEvent.disableClickPropagation(this._div);

    return this._div;
};

abstract.addTo(map);
		
        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
            if (bounds_group.getLayers().length) {
                map.fitBounds(bounds_group.getBounds());
            }
        }
        map.createPane('pane_Positronnolabels_0');
        map.getPane('pane_Positronnolabels_0').style.zIndex = 400;
        var layer_Positronnolabels_0 = L.tileLayer('https://a.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png', {
            pane: 'pane_Positronnolabels_0',
            opacity: 1.0,
            attribution: '<a href="https://cartodb.com/basemaps/">Map tiles by CartoDB, under CC BY 3.0. Data by OpenStreetMap, under ODbL.</a>',
            minZoom: 5,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 20
        });
        layer_Positronnolabels_0;
        map.addLayer(layer_Positronnolabels_0);
        function pop_Postalcodeareas_1(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
			let indicatorValue = feature.properties['indicator'];
			let indicatorLabel = '';

			if (indicatorValue >= 0.000 && indicatorValue <= 0.106) {
			    indicatorLabel = 'Very high';
			} else if (indicatorValue > 0.106 && indicatorValue <= 0.165) {
			    indicatorLabel = 'High';
			} else if (indicatorValue > 0.165 && indicatorValue <= 0.219) {
			    indicatorLabel = 'Moderate';
			} else if (indicatorValue > 0.219 && indicatorValue <= 0.292) {
			    indicatorLabel = 'Low';
			} else if (indicatorValue > 0.292) {
			    indicatorLabel = 'Very low';
			} else {
			    indicatorLabel = 'No data';
			}
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Name</th>\
                        <td class="visible-with-data" id="nimi">' + (feature.properties['nimi'] !== null ? autolinker.link(String(feature.properties['nimi']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Basic education only</th>\
                        <td>' + (feature.properties['ko_perus'] !== null ? autolinker.link(String(feature.properties['ko_perus']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Median income</th>\
                        <td>' + (feature.properties['hr_mtu'] !== null ? autolinker.link(String(feature.properties['hr_mtu']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Unemployment rate (%)</th>\
                        <td class="visible-with-data" id="Emplyotyme">' + (feature.properties['Emplyotyme'] !== null ? autolinker.link(String(feature.properties['Emplyotyme']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
			</table>\
<p style="margin:2px 0; line-height:1.0; font-size:13px; color:#333;">\
<b>Socioeconomic status: </b>' + indicatorLabel + '\
			</p>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, {
			  maxHeight: 300,
			  maxWidth: 300,
			  offset: L.point(10, -5)
			});
		}
			const indicatorLegend = [
		  { color: 'rgba(35,35,35,0.7)', label: 'Very high' },
		  { color: 'rgba(102,102,102,0.7)', label: 'High' },
		  { color: 'rgba(176,176,176,0.7)', label: 'Moderate' },
		  { color: 'rgba(213,213,213,0.7)', label: 'Low' },
		  { color: 'rgba(250,250,250,0.7)', label: 'Very low' }
		];
        function style_Postalcodeareas_1_0(feature) {
            if (feature.properties['indicator'] >= 0.000000 && feature.properties['indicator'] <= 0.106000 ) {
                return {
                pane: 'pane_Postalcodeareas_1',
                opacity: 1,
                color: 'rgba(35,35,35,0.7)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(102,102,102,0.7)',
                interactive: true,
            }
            }
            if (feature.properties['indicator'] >= 0.106000 && feature.properties['indicator'] <= 0.128000 ) {
                return {
                pane: 'pane_Postalcodeareas_1',
                opacity: 1,
                color: 'rgba(35,35,35,0.7)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(139,139,139,0.7)',
                interactive: true,
            }
            }
            if (feature.properties['indicator'] >= 0.128000 && feature.properties['indicator'] <= 0.172000 ) {
                return {
                pane: 'pane_Postalcodeareas_1',
                opacity: 1,
                color: 'rgba(35,35,35,0.7)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(176,176,176,0.7)',
                interactive: true,
            }
            }
            if (feature.properties['indicator'] >= 0.172000 && feature.properties['indicator'] <= 0.235000 ) {
                return {
                pane: 'pane_Postalcodeareas_1',
                opacity: 1,
                color: 'rgba(35,35,35,0.7)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(213,213,213,0.7)',
                interactive: true,
            }
            }
            if (feature.properties['indicator'] >= 0.235000 && feature.properties['indicator'] <= 0.272000 ) {
                return {
                pane: 'pane_Postalcodeareas_1',
                opacity: 1,
                color: 'rgba(35,35,35,0.7)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(250,250,250,0.7)',
                interactive: true,
            }
            }
        }
        map.createPane('pane_Postalcodeareas_1');
        map.getPane('pane_Postalcodeareas_1').style.zIndex = 401;
        map.getPane('pane_Postalcodeareas_1').style['mix-blend-mode'] = 'normal';
        var layer_Postalcodeareas_1 = new L.geoJson(json_Postalcodeareas_1, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Postalcodeareas_1',
            layerName: 'layer_Postalcodeareas_1',
            pane: 'pane_Postalcodeareas_1',
            onEachFeature: pop_Postalcodeareas_1,
            style: style_Postalcodeareas_1_0,
        });
        bounds_group.addLayer(layer_Postalcodeareas_1);
        map.addLayer(layer_Postalcodeareas_1);
        function pop_Buffers_2(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Buffers_2_0() {
            return {
                pane: 'pane_Buffers_2',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 0.2,
                fillColor: 'rgba(229,182,54,1.0)',
                interactive: false,
            }
        }
        map.createPane('pane_Buffers_2');
        map.getPane('pane_Buffers_2').style.zIndex = 405;
        map.getPane('pane_Buffers_2').style['mix-blend-mode'] = 'normal';
        var layer_Buffers_2 = new L.geoJson(json_Buffers_2, {
		    style: { color: '#ff0000', fillOpacity: 0.2, weight: 2 },
		    onEachFeature: pop_Buffers_2
		});
		bounds_group.addLayer(layer_Buffers_2);
        function pop_Tramline_3(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
			
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['FID'] !== null ? autolinker.link(String(feature.properties['FID']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }
		function showBufferAndServices(stop_id) {
				    const buffer = json_Buffers_2.features.find(f => f.properties.stop_id == stop_id);
				    if (!buffer) return;

				    layer_Buffers_2.clearLayers().addData(buffer).addTo(map);

				    const servicesInBuffer = json_Wellbeingservicesmerged_5.features.filter(f =>
				        turf.booleanPointInPolygon(f, buffer)
				    );
				    layer_Wellbeingservicesmerged_5.clearLayers().addData({ type:'FeatureCollection', features: servicesInBuffer }).addTo(map);
}
        function style_Tramline_3_0() {
            return {
                pane: 'pane_Tramline_3',
                opacity: 1,
                color: 'rgba(0,35,34,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 3.0,
                fillOpacity: 0,
                interactive: false,
            }
        }
        map.createPane('pane_Tramline_3');
        map.getPane('pane_Tramline_3').style.zIndex = 406;
        map.getPane('pane_Tramline_3').style['mix-blend-mode'] = 'normal';
        var layer_Tramline_3 = new L.geoJson(json_Tramline_3, {
            attribution: '',
            interactive: false,
            dataVar: 'json_Tramline_3',
            layerName: 'layer_Tramline_3',
            pane: 'pane_Tramline_3',
            onEachFeature: pop_Tramline_3,
            style: style_Tramline_3_0,
        });
        bounds_group.addLayer(layer_Tramline_3);
        map.addLayer(layer_Tramline_3);
        function pop_Tramstops_4(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
				<tr>\
                        <th scope="row">Stop name</th>\
                        <td class="visible-with-data" id="Nimi">' + (feature.properties['Nimi'] !== null ? autolinker.link(String(feature.properties['Nimi']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Schools</th>\
                        <td class="visible-with-data" id="school">' + (feature.properties['school'] !== null ? autolinker.link(String(feature.properties['school']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Culture services</th>\
                        <td class="visible-with-data" id="culture">' + (feature.properties['culture'] !== null ? autolinker.link(String(feature.properties['culture']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Sport & wellbeing</th>\
                        <td class="visible-with-data" id="sport">' + (feature.properties['sport'] !== null ? autolinker.link(String(feature.properties['sport']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400,
			 offset: L.point(30, -10) });
        }

        function style_Tramstops_4_0() {
            return {
                pane: 'pane_Tramstops_4',
                radius: 4.0,
                opacity: 1,
                color: 'rgba(0,0,0,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 2.0,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(255,250,229,1.0)',
                interactive: true,
            }
        }
        map.createPane('pane_Tramstops_4');
        map.getPane('pane_Tramstops_4').style.zIndex = 407;
        map.getPane('pane_Tramstops_4').style['mix-blend-mode'] = 'normal';
        var layer_Tramstops_4 = new L.geoJson(json_Tramstops_4, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Tramstops_4',
            layerName: 'layer_Tramstops_4',
            pane: 'pane_Tramstops_4',
            onEachFeature: pop_Tramstops_4,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {},
					radius: 8.0,
					color: 'black',
					fillColor:'white'
                };
                return L.circleMarker(latlng, style_Tramstops_4_0(feature));
            },
        });
        bounds_group.addLayer(layer_Tramstops_4);
        map.addLayer(layer_Tramstops_4);
		layer_Tramstops_4.on('click', function(e){
		    var stop_id = e.layer.feature.properties.stop_id; 
		    showBufferAndServices(stop_id);
		});
        function pop_Wellbeingservicesmerged_5(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">kohteen_ni</th>\
                        <td class="visible-with-data" id="kohteen_ni">' + (feature.properties['kohteen_ni'] !== null ? autolinker.link(String(feature.properties['kohteen_ni']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Wellbeingservicesmerged_5_0(feature) {
            switch(String(feature.properties['layer'])) {
                case 'Culture services':
                    return {
                pane: 'pane_Wellbeingservicesmerged_5',
                radius: 6.0,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(197,19,233,1.0)',
                interactive: true,
            }
                    break;
                case 'Schools':
                    return {
                pane: 'pane_Wellbeingservicesmerged_5',
                radius: 4.0,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(69,176,230,1.0)',
                interactive: true,
            }
                    break;
                case 'Sport & Wellbeing services':
                    return {
                pane: 'pane_Wellbeingservicesmerged_5',
                radius: 4.0,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(227,153,117,1.0)',
                interactive: true,
            }
                    break;
            }
        }
        map.createPane('pane_Wellbeingservicesmerged_5');
        map.getPane('pane_Wellbeingservicesmerged_5').style.zIndex = 405;
        map.getPane('pane_Wellbeingservicesmerged_5').style['mix-blend-mode'] = 'normal';
		const categoryColors = {
		  'Culture services': '#ffa500',
		  'Schools': '#0000ff',
		  'Sport & Wellbeing services': '#FF0000'
		};
        var layer_Wellbeingservicesmerged_5 = new L.geoJson(json_Wellbeingservicesmerged_5,{
		    pointToLayer: function(feature, latlng) {
				const color = categoryColors[feature.properties.layer] || '#999999';
		        return L.circleMarker(latlng, {
		            radius: 6,
		            color: color,
					fillColor: color,
		            fillOpacity: 1,
					weight: 1
		        });
		    },
		    onEachFeature: function(feature, layer) {
		        layer.bindPopup(feature.properties.kohteen_ni); 
		    }
		});
		bounds_group.addLayer(layer_Wellbeingservicesmerged_5); 
		map.removeLayer(layer_Wellbeingservicesmerged_5); 
        map.createPane('pane_Culture_heatmap_6');
        map.getPane('pane_Culture_heatmap_6').style.zIndex = 402;
		var serviceLegend = L.control({ position: 'bottomright' });

		serviceLegend.onAdd = function (map) {
		    var div = L.DomUtil.create('div', 'info legend');
		    div.style.background = 'white';
		    div.style.padding = '8px';
		    div.style.borderRadius = '6px';
		    div.style.boxShadow = '0 0 5px rgba(0,0,0,0.3)';
		    div.style.lineHeight = '1.5em';
		    div.style.fontSize = '12px';

		    div.innerHTML += '<b>Service points</b><br>';

		    for (const key in categoryColors) {
		        div.innerHTML +=
		            '<i style="background:' + categoryColors[key] + ';border-radius:50%; width:12px; height:12px; display:inline-block; margin-right:6px;"></i> ' +
		            key + '<br>';
		    }
			div.innerHTML += '<hr style="margin:6px 0;">';
			    div.innerHTML += '<b>Tram network</b><br>' +
			        '<i style="background:none; border:2px solid #000000; width:18px; height:0; display:inline-block; margin-right:6px; vertical-align:middle;"></i> Tramline<br>' +
			        // Tram stops (piste)
			        '<i style="background:#FFFFFF; border:2px solid #000000; border-radius:50%; width:10px; height:10px; display:inline-block; margin-right:6px; vertical-align:middle;"></i> Tram stops<br>';

		    return div;
		};

		serviceLegend.addTo(map);
        var img_Culture_heatmap_6 = 'data/Culture_heatmap_6.png';
        var img_bounds_Culture_heatmap_6 = [[60.39846105519988,22.157601967981346],[60.496103264247516,22.42368253219364]];
        var layer_Culture_heatmap_6 = new L.imageOverlay(img_Culture_heatmap_6,
                                              img_bounds_Culture_heatmap_6,
                                              {pane: 'pane_Culture_heatmap_6', opacity:0.7});
        bounds_group.addLayer(layer_Culture_heatmap_6);
        map.addLayer(layer_Culture_heatmap_6);
        map.createPane('pane_Sport_heatmap_7');
        map.getPane('pane_Sport_heatmap_7').style.zIndex = 403;
        var img_Sport_heatmap_7 = 'data/Sport_heatmap_7.png';
        var img_bounds_Sport_heatmap_7 = [[60.38274903992388,22.07849305479689],[60.500974814231526,22.4333581376815]];
        var layer_Sport_heatmap_7 = new L.imageOverlay(img_Sport_heatmap_7,
                                              img_bounds_Sport_heatmap_7,
                                              {pane: 'pane_Sport_heatmap_7', opacity:0.7});
        bounds_group.addLayer(layer_Sport_heatmap_7);
        map.addLayer(layer_Sport_heatmap_7);
        map.createPane('pane_Schools_heatmap_8');
        map.getPane('pane_Schools_heatmap_8').style.zIndex = 404;
        var img_Schools_heatmap_8 = 'data/Schools_heatmap_8.png';
        var img_bounds_Schools_heatmap_8 = [[60.38937553156401,22.156820491251903],[60.50136567649106,22.425865466547005]];
        var layer_Schools_heatmap_8 = new L.imageOverlay(img_Schools_heatmap_8,
                                              img_bounds_Schools_heatmap_8,
                                              {pane: 'pane_Schools_heatmap_8', opacity:0.7});
        bounds_group.addLayer(layer_Schools_heatmap_8);
        map.addLayer(layer_Schools_heatmap_8);
        const url = {"Nominatim OSM": "https://nominatim.openstreetmap.org/search?format=geojson&addressdetails=1&",
        "France BAN": "https://api-adresse.data.gouv.fr/search/?"}
        var photonControl = L.control.photon({
            url: url["Nominatim OSM"],
            feedbackLabel: '',
            position: 'topleft',
            includePosition: true,
            initial: true,
            // resultsHandler: myHandler,
        }).addTo(map);
        photonControl._container.childNodes[0].style.borderRadius="10px"
        // Create a variable to store the geoJSON data
        var x = null;
        // Create a variable to store the marker
        var marker = null;
        // Add an event listener to the Photon control to create a marker from the returned geoJSON data
        var z = null;
        photonControl.on('selected', function(e) {
            console.log(photonControl.search.resultsContainer);
            if (x != null) {
                map.removeLayer(obj3.marker);
                map.removeLayer(x);
            }
            obj2.gcd = e.choice;
            x = L.geoJSON(obj2.gcd).addTo(map);
            var label = typeof obj2.gcd.properties.label === 'undefined' ? obj2.gcd.properties.display_name : obj2.gcd.properties.label;
            obj3.marker = L.marker(x.getLayers()[0].getLatLng()).bindPopup(label).addTo(map);
            map.setView(x.getLayers()[0].getLatLng(), 17);
            z = typeof e.choice.properties.label === 'undefined'? e.choice.properties.display_name : e.choice.properties.label;
            console.log(e);
            e.target.input.value = z;
        });
        var search = document.getElementsByClassName("leaflet-photon leaflet-control")[0];
        search.classList.add("leaflet-control-search")
        search.style.display = "flex";
        search.style.backgroundColor="rgba(255,255,255,0.5)" 

        // Create the new button element
        var button = document.createElement("div");
        button.id = "gcd-button-control";
        button.className = "gcd-gl-btn fa fa-search search-button";

        // Insert the button at the beginning of the search control
        search.insertBefore(button, search.firstChild);
        last = search.lastChild;
        last.style.display = "none";
        button.addEventListener("click", function (e) {
            if (last.style.display === "none") {
                last.style.display = "block";
            } else {
                last.style.display = "none";
            }
        });
        var overlaysTree = [
		// Add headings to the different layer categories
			{
				label: '<span style="font-size:14px;"><b>Heatmaps of wellbeing services</b>',
				children: [
					{ label: "üè´ Schools", layer: layer_Schools_heatmap_8 },
					{ label: "üèãÔ∏è Sport & wellbeing services", layer: layer_Sport_heatmap_7 },
					{ label: "üé® Culture services", layer: layer_Culture_heatmap_6 },
				],
			},
			{
				label:'<span style="font-size:14px;"><b>Socioeconomic status</b>',
				children: [
				{
					label:
						'Postal code areas<br />' +
						'<table>' +
						indicatorLegend
						.map(
						(l) =>
							`<tr><td><i style="background:${l.color}; width:12px; height:12px; display:inline-block; margin-right:6px;border:1px solid #555;"></i></td><td>${l.label}</td></tr>`
						)
						.join('') +
					'</table>',
				layer: layer_Postalcodeareas_1,
				},
				],
			},
			{
				label: '<span style="font-size:14px;"><b>Base map</b>',
				children: [
				{ label: "Positron", layer: layer_Positronnolabels_0, radioGroup: "bm" },
				],
			},
			];
			var lay = L.control.layers.tree(null, overlaysTree, {
			    collapsed: true,
			}).addTo(map);
        setBounds();
        L.ImageOverlay.include({
            getBounds: function () {
                return this._bounds;
            }
        });
        </script>
    </body>
</html>
